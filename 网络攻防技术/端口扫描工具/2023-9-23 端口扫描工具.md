### 前置知识：扫描类型

#### **1、TCP全连接扫描**：

	此扫描试图与每一个TCP端口进行“三次握手”通信。如果能够成功建立接连，则证明端口开放，否则为关闭。准确度很高，但是最容易被防火墙和IDS检测到，并且在目标主机的日志中会记录大量的连接请求以及错误信息。

TCP connect端口扫描服务端与客户端建立连接成功（目标端口开放）的过程： 
① Client端发送SYN；
② Server端返回SYN/ACK，表明端口开放；
③ Client端返回ACK，表明连接已建立；
④ Client端主动断开连接。

建立连接成功（目标端口开放）如图所示

![[Pasted image 20230923112951.png]]

**TCP connect端口扫描服务端与客户端未建立连接成功（目标端口关闭）过程：** 

① Client端发送SYN；
② Server端返回RST/ACK，表明端口未开放。
未建立连接成功(目标端口关闭)

**优点：实现简单**，**对操作者的权限没有严格要求**（有些类型的端口扫描需要操作者具有root权限），系统中的任何用户都有权力使用这个调用，而且如果想要得到从目标端口返回banners信息，也只能采用这一方法。

另一优点是**扫描速度快**。如果对每个目标端口以线性的方式，使用单独的connect()调用，可以通过同时打开多个套接字，从而加速扫描。

**缺点：** 是**会在目标主机的日志记录中留下痕迹**，易被发现，**并且数据包会被过滤掉**。目标主机的logs文件会显示一连串的连接和连接出错的服务信息，并且能很快地使它关闭。

#### **2、SYN扫描**：

	扫描器向目标主机的一个端口发送请求连接的SYN包，扫描器在收到SYN/ACK后，不是发送的ACK应答而是发送RST包请求断开连接。这样，三次握手就没有完成，无法建立正常的TCP连接，因此，这次扫描就不会被记录到系统日志中。这种扫描技术一般不会在目标主机上留下扫描痕迹。但是，这种扫描需要有root权限。

![[Pasted image 20230923113938.png]]

**端口开放**：1、Client发送SYN  2、Server端发送SYN/ACK 3、Client发送RST断开（只需要前两步就可以判断端口开放）

**端口关闭**：1、Client发送SYN  2、Server端回复RST（表示端口关闭）

**优点：SYN扫描要比TCP Connect()扫描隐蔽一些**，SYN仅仅需要发送初始的SYN数据包给目标主机，如果端口开放，则相应SYN-ACK数据包；如果关闭，则响应RST数据包；

#### **3、NULL扫描**：

**反向扫描**----原理是将一个没有设置任何标志位的数据包发送给TCP端口，在正常的通信中至少要设置一个标志位，根据RFC 793的要求，在端口关闭的情况下，若收到一个没有设置标志位的数据字段，那么主机应该舍弃这个分段，并发送一个RST数据包，否则不会响应发起扫描的客户端计算机。也就是说，如果TCP端口处于关闭则响应一个RST数据包，若处于开放则无相应。但是应该知道理由NULL扫描要求所有的主机都符合RFC 793规定，但是windows系统主机不遵从RFC 793标准，且只要收到没有设置任何标志位的数据包时，不管端口是处于开放还是关闭都响应一个RST数据包。但是基于Unix(\*nix,如Linux)遵从RFC 793标准，所以可以用NULL扫描。 

**经过上面的分析，我们知道NULL可以辨别某台主机运行的操作系统是什么操作系统。**

**端口开放：Client发送Null，server没有响应，如下图**

![[Pasted image 20230923113927.png]]

**端口关闭：1、Client发送NUll   2、Server回复RST，如下图**

![[Pasted image 20230923114000.png]]

**说明：** NULL扫描和前面的TCP Connect（）和SYN的判断条件正好相反。在前两种扫描中，有响应数据包的表示端口开放，**但在NULL扫描中，收到响应数据包表示端口关闭**。反向扫描比前两种隐蔽性高些，但精确度也相对低一些。

#### **4、FIN扫描**：

       与NULL有点类似，只是FIN为指示TCP会话结束，在FIN扫描中一个设置了FIN位的数据包被发送后，若响应RST数据包，则表示端口关闭，没有响应则表示开放。此类扫描同样不能准确判断windows系统上端口开发情况。
       
**端口开放：发送FIN，没有响应
端口关闭：1、客户端发送FIN  
				 2、服务端回复RST**

#### **5、ACK扫描**（拓展）：

     扫描主机向目标主机发送ACK数据包。根据返回的RST数据包有两种方法可以得到端口的信息。方法一是： 若返回的RST数据包的TTL值小于或等于64，则端口开放，反之端口关闭，如图所示。

![[Pasted image 20230923114518.png]]

#### **6、Xmas扫描**：

通过发送带有下列标志位的tcp数据包

	URG：指示数据时紧急数据，应立即处理。

	PSH：强制将数据压入缓冲区。

	FIN：在结束TCP会话时使用。

正常情况下，三个标志位不能被同时设置，但在此种扫描中可以用来判断哪些端口关闭还是开放，与上面的反向扫描情况相同，依然不能判断windows平台上的端口。

**端口开放：发送URG/PSH/FIN,  没有响应，如下图**

![[Pasted image 20230923114805.png]]

**端口关闭：1、发送URG/PSH/FIN,没有响应   2、响应RST，如下图**

![[Pasted image 20230923114826.png]]

XMAS扫描原理和NULL扫描的类似，**将TCP数据包中的ACK、FIN、RST、SYN、URG、PSH标志位置1后发送给目标主机。在目标端口开放的情况下，目标主机将不返回任何信息**。

### 实验过程

#### 本机端口情况：

![[截屏2023-09-25 10.29.21.png]]

##### Part1.本机开放端口扫描
现对开放端口5000进行nmap扫描：结果为Open

![[截屏2023-09-25 10.30.58.png]]

TCP扫描结果：Open

![[截屏2023-09-25 10.31.59.png]]

SYN扫描结果：Open

![[截屏2023-09-25 10.32.37.png]]

FIN扫描结果：Open或被过滤

![[截屏2023-09-25 10.33.18.png]]

XMAS扫描结果：Open或被过滤

![[截屏2023-09-25 10.35.28.png]]

NULL扫描结果：Open或被过滤

![[截屏2023-09-25 10.36.18.png]]

##### Part2.本机关闭端口扫描

关闭防火墙：

![[截屏2023-09-25 10.45.16.png]]

使用nmap对666端口进行扫描：结果为Closed

![[截屏2023-09-25 10.38.00.png]]

本机实际扫描结果：TCP与SYN结果正确，但FIN，XMAS和NULL扫描结果均被过滤

![[截屏2023-09-25 10.47.52.png]]

##### Part3.远程有防火墙的关闭端口进行扫描

使用nmap对fangzhiyang.cn的9999端口进行扫描，结果为Closed

![[截屏2023-09-25 10.50.37.png]]

使用本机测试程序进行扫描，结果同样是XMAS、NULL与FIN扫描结果被过滤，SYN与TCP扫描较为稳定。

![[截屏2023-09-25 10.53.24.png]]

##### Part4.对远程开启防火墙主机的开放端口进行扫描

使用nmap对fangzhiyang.cn的80端口进行扫描：结果为开放

![[截屏2023-09-25 10.54.54.png]]

使用本机的测试程序进行扫描：结果都合理

![[截屏2023-09-25 10.58.58.png]]

### 总结
端口扫描失败的原因有很多。简单枚举一些：

1. 防火墙过滤：目标主机上的防火墙可能配置了规则来过滤或阻止扫描器访问。如果扫描流量被防火墙过滤，端口扫描将无法成功，并且显示端口被过滤。
2. 主机或网络不可达：如果目标主机或扫描器所在的网络无法与目标主机进行通信，端口扫描将失败。
3. 目标主机限制访问：目标主机可能配置了访问控制列表（ACL）或其他安全机制，限制特定IP地址或IP地址范围的访问。
4. 扫描器配置或设置问题：端口扫描器的配置或设置可能不正确，导致扫描失败。
5. 扫描器被检测到：某些网络防御系统可以临时封锁扫描器的IP地址、限制扫描速率或发送虚假响应以干扰扫描器。

参考链接：
https://blog.csdn.net/qq_45534118/article/details/108544843
https://blog.csdn.net/weixin_39953244/article/details/110890333
https://blog.csdn.net/u011332540/article/details/129365222